# 简单的反向代理

### 名词解析

在计算机网络中，反向代理是代理服务器的一种。它根据客户端的请求，从后端的服务器上获取资源，然后再将这些资源返回给客户端。与前向代理不同，前向代理作为一个媒介将互联网上获取的资源返回给相关联的客户端，而反向代理是在服务器端作为代理使用，而不是客户端。 --- 《维基百科》

---

### 主要用途

* 在一个内网中，假如只有少部分电脑有公网IP，内网中的其他电脑如果也需要对外提供服务
* 同一台电脑上的多个程序都需要监听80端口时，导致冲突

本人的需求：

> * 由于我们在学校实验室用的是校园网，在宿舍用的非校园网，自己或者周围同学的电脑或多或少的当服务器用，当回到宿舍时，当需要访问自己或者同学的电脑时，无法访问
> * 学校很多网站都只是对内网开放，有时在非校园网时非常需要

试过的一些解决方案

> * 最初时使用`Nginx`进行反向代理，嫌每次都需要命令行更改太麻烦（主要不会用其他的方式改）
> * 后来又用`SSH -L` `SSH -R`代理单个网站
> * 用`SSH -D` 进行代理整个内网
> 总感觉有时候不太方便，所以就写了这个，算是自己使用的一个补充吧

---

### 具体实现

> 本程序只是简单的使用 Node.js 的 http-proxy 实现，代码使用Coffee编写，主要特点就是提供WEB页面，可以动态增加或删除。
> 计数延迟的原因：为了减轻压力，代码在最初运行时会读取数据库，以后数据都只是暂存在变量中，只是每隔几分钟会有定时任务，将数据更新到数据库

![截图](/static/images/pic.png)

---

### 简单说明

程序首先获取当前访问域名，判断是否主域名，如果为主域名则显示WEB编辑页面，非主域名并存在反向代理记录的域名则进行反向代理，其他域名则重定向回主域名

由于懒得写登陆注册之类的，WEB编辑页面的权限验证直接使用的是微信企业号，登陆方式为扫码登陆


config.coffee

> * host 对应监听的IP
> * port 对应监听的端口
> * domain 对应WEB页面访问的域名
> * mysqlInfo 对应数据库的一些信息


proxy.coffee

> 程序的入口文件，一些流处理及定义一些RESTful API


action.coffee

> 程序的WEB页面控制器，定义一些增删改查造作


model.coffee

> 程序的数据模型页面，定义一些对数据库的操作，由于数据量不大，直接使用的变量对数据进行缓存

wechat.coffee

> 微信企业号的一些操作，主要用户管理用户的登陆、注销等操作
